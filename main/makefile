# æ–‡ä»¶ä¿æŠ¤è€…ç¼–è¯‘é…ç½®
CXX = g++
# ç¼–è¯‘é€‰é¡¹ï¼š
CXXFLAGS = -Wall -fPIC -std=c++17 -O2 -pthread -I./ol/include
# åŠ¨æ€åº“é“¾æ¥å‚æ•°ï¼š
LDFLAGS = -shared -fPIC -Wl,--whole-archive ./ol/lib/libol.a -Wl,--no-whole-archive -ldl -pthread

# ç›®æ ‡æ–‡ä»¶ï¼š
SO_FILE = libfile_protector.so

# æµ‹è¯•æ–‡ä»¶è·¯å¾„
TEST_DIR = ../test

# ç¼–è¯‘åŠ¨æ€åº“
all: $(SO_FILE) $(TEST_DIR)/test_norm $(TEST_DIR)/test_prot

# åŠ¨æ€åº“ç¼–è¯‘
$(SO_FILE): File_Protector.o
	$(CXX) $(LDFLAGS) -o $@ $^
	@echo "âœ… åŠ¨æ€åº“ç¼–è¯‘å®Œæˆï¼š$@"

File_Protector.o: File_Protector.cpp
	$(CXX) $(CXXFLAGS) -c -o $@ $<

# éç™½åå•æµ‹è¯•ç¨‹åº
$(TEST_DIR)/test_norm: $(TEST_DIR)/test_norm.cpp
	$(CXX) -std=c++17 -o $@ $< -pthread
	@echo "âœ… éç™½åå•æµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆï¼š$@"

# ç™½åå•æµ‹è¯•ç¨‹åº
$(TEST_DIR)/test_prot: $(TEST_DIR)/test_prot.cpp
	$(CXX) -std=c++17 -o $@ $< -pthread
	@echo "âœ… ç™½åå•æµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆï¼š$@"

# æµ‹è¯•ç›®æ ‡
test: all
	@echo "========================================"
	@echo "ğŸ” ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæµ‹è¯•æ–‡ä»¶"
	@touch $(TEST_DIR)/prot.txt $(TEST_DIR)/norm.txt
	@echo "âœ… æµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆ"

	@echo "========================================"
	@echo "ğŸ” ç¬¬äºŒæ­¥ï¼šæµ‹è¯•éç™½åå•è¿›ç¨‹ï¼ˆtest_normï¼‰"
	LD_PRELOAD=./$(SO_FILE) $(TEST_DIR)/test_norm

	@echo "========================================"
	@echo "ğŸ” ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•ç™½åå•è¿›ç¨‹ï¼ˆtest_protï¼‰"
	LD_PRELOAD=./$(SO_FILE) $(TEST_DIR)/test_prot

	@echo "========================================"
	@echo "ğŸ” ç¬¬å››æ­¥ï¼šæŸ¥çœ‹æ‹¦æˆªæ—¥å¿—"
	@tail -20 file_protector.log || echo "æ—¥å¿—æ–‡ä»¶æš‚æœªç”Ÿæˆ"

# æ¸…ç†
clean:
	rm -f *.o *.so $(TEST_DIR)/test_norm $(TEST_DIR)/test_prot
	rm -f ./file_protector.log
	@echo "âœ… æ¸…ç†å®Œæˆ"